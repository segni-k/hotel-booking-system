# Deployment Guide — EliteStay Hotel Booking System

## Architecture

```
┌─────────────────┐         ┌─────────────────────┐
│   Vercel         │  HTTPS  │   Render              │
│                  │ ──────► │                       │
│  Next.js 15      │         │  Laravel 12 API       │
│  (Frontend)      │         │  (Docker: Nginx+PHP)  │
│                  │         │                       │
│  *.vercel.app    │         │  *.onrender.com       │
└─────────────────┘         └────────┬──────────────┘
                                     │
                                     ▼
                            ┌────────────────────┐
                            │  Render PostgreSQL  │
                            └────────────────────┘
```

---

## 1. Backend — Deploy to Render

### Option A: Blueprint (Recommended)

1. Push this repo to GitHub
2. Go to [Render Dashboard](https://dashboard.render.com)
3. Click **New** → **Blueprint**
4. Connect your GitHub repo
5. Render auto-detects `render.yaml` and creates:
   - A **Web Service** (Docker) for the Laravel API
   - A **PostgreSQL** database
6. Set the `sync: false` environment variables:

| Variable | Value |
|---|---|
| `APP_URL` | `https://hotel-booking-api.onrender.com` (your Render URL) |
| `FRONTEND_URL` | `https://your-app.vercel.app` (your Vercel URL) |
| `SANCTUM_STATEFUL_DOMAINS` | `your-app.vercel.app` |
| `CHAPA_SECRET_KEY` | Your Chapa secret key |
| `CHAPA_WEBHOOK_SECRET` | Your Chapa webhook secret |

### Option B: Manual Setup

1. **Create PostgreSQL database** on Render (free tier)
2. **Create Web Service** → Docker
   - Root Directory: `backend`
   - Dockerfile Path: `./Dockerfile`
   - Set all env vars from `.env.example`
   - Set `DATABASE_URL` from the PostgreSQL service's connection string

### After Deploy

The entrypoint script automatically:
- Generates `APP_KEY` if not set
- Caches config, routes, views
- Runs migrations
- Seeds the database

### Verify

```bash
curl https://your-app.onrender.com/api/v1/hotels
```

---

## 2. Frontend — Deploy to Vercel

### Setup

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Click **Add New** → **Project**
3. Import your GitHub repo
4. Configure:
   - **Framework Preset**: Next.js (auto-detected)
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`
   - **Install Command**: `npm ci`

### Environment Variables

Set these in Vercel **Project Settings → Environment Variables**:

| Variable | Value | Environment |
|---|---|---|
| `NEXT_PUBLIC_API_URL` | `https://your-app.onrender.com/api/v1` | Production |
| `NEXT_PUBLIC_APP_URL` | `https://your-app.vercel.app` | Production |
| `NEXT_PUBLIC_APP_NAME` | `EliteStay` | All |
| `NEXT_PUBLIC_CHAPA_PUBLIC_KEY` | Your Chapa public key | Production |

### Verify

Visit your `*.vercel.app` URL — the site should load and API calls should reach Render.

---

## 3. Post-Deploy Checklist

- [ ] Backend responds at `/api/v1/hotels`
- [ ] Frontend loads at Vercel URL
- [ ] Register a new account → verify it works
- [ ] Login → verify token-based auth works
- [ ] Browse rooms → data loads from API
- [ ] Book a room → login gate works → booking submits
- [ ] Chapa payment flow (if keys are configured)
- [ ] CORS: no browser console errors on cross-origin requests

---

## 4. Environment Variables Reference

### Backend (Render)

| Variable | Required | Description |
|---|---|---|
| `APP_KEY` | Yes | Auto-generated by Render blueprint |
| `APP_URL` | Yes | Your Render service URL |
| `DATABASE_URL` | Yes | Auto-linked from Render PostgreSQL |
| `FRONTEND_URL` | Yes | Your Vercel URL (for CORS) |
| `SANCTUM_STATEFUL_DOMAINS` | Yes | Your Vercel domain |
| `CHAPA_SECRET_KEY` | For payments | Chapa API secret |
| `CHAPA_WEBHOOK_SECRET` | For payments | Chapa webhook verification |
| `LOG_CHANNEL` | No | Default: `stderr` (best for Render) |

### Frontend (Vercel)

| Variable | Required | Description |
|---|---|---|
| `NEXT_PUBLIC_API_URL` | Yes | Render backend URL + `/api/v1` |
| `NEXT_PUBLIC_APP_URL` | Yes | Your Vercel URL |
| `NEXT_PUBLIC_APP_NAME` | No | Default: `EliteStay` |
| `NEXT_PUBLIC_CHAPA_PUBLIC_KEY` | For payments | Chapa public key |

---

## 5. Local Development

```bash
# Backend
cd backend
cp .env.example .env
php artisan key:generate
php artisan migrate --seed
php artisan serve   # → http://localhost:8000

# Frontend
cd frontend
# .env.local already points to localhost:8000
npm install
npm run dev         # → http://localhost:3000
```

---

## 6. Troubleshooting

| Issue | Fix |
|---|---|
| CORS errors in browser | Ensure `FRONTEND_URL` is set correctly on Render |
| 401 on API calls | Check `SANCTUM_STATEFUL_DOMAINS` includes your Vercel domain |
| Database connection failed | Verify `DATABASE_URL` is linked from Render PostgreSQL |
| Build fails on Render | Check Docker build logs; ensure `composer.lock` is committed |
| Images not loading | `next.config.ts` allows all HTTPS hosts by default |
| Render free tier sleeps | First request after inactivity takes ~30s to cold-start |
